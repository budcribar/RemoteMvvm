<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<PropertyGroup>
		<_ProtoGeneratorUtilExePath Condition="Exists('$(MSBuildThisFileDirectory)..\tools\net8.0\ProtoGeneratorUtil.exe')">$(MSBuildThisFileDirectory)..\tools\net8.0\ProtoGeneratorUtil.exe</_ProtoGeneratorUtilExePath>
		<_ProtoGeneratorUtilExePath Condition="Exists('$(MSBuildThisFileDirectory)..\tools\net6.0\ProtoGeneratorUtil.exe') AND '$(_ProtoGeneratorUtilExePath)' == ''">$(MSBuildThisFileDirectory)..\tools\net6.0\ProtoGeneratorUtil.exe</_ProtoGeneratorUtilExePath>
		<_DefaultAttributeDefinitionSourceFileRelativePath>PeakSWC\Mvvm\Remote\GenerateGrpcRemoteAttribute.cs</_DefaultAttributeDefinitionSourceFileRelativePath>
	</PropertyGroup>

	<Target Name="PeakSWC_GenerateProtoFiles"
			BeforeTargets="CoreCompile;BeforeResGen;ProtoCompile"
			DependsOnTargets="ResolveAssemblyReferences;PeakSWC_PrepareProtoGenerationItems"
			Condition="'@(_MvvmViewModelProtoSourceProcessed)' != '' AND '$(_ProtoGeneratorUtilExePath)' != '' AND Exists('$(_ProtoGeneratorUtilExePath)')">

		<Message Text="PeakSWC.MvvmSourceGenerator: Starting .proto file generation..." Importance="high" />
		<Message Text="PeakSWC.MvvmSourceGenerator: ProtoGeneratorUtil.exe path: $(_ProtoGeneratorUtilExePath)" Importance="normal" />

		<PropertyGroup>
			<_ProtoUtil_ReferencePaths Condition="'@(ReferencePathWithRefAssemblies)' != ''">@(ReferencePathWithRefAssemblies->WithMetadataValue('Extension', '.dll')->'%(FullPath)', ';')</_ProtoUtil_ReferencePaths>
			<_ProtoUtil_ReferencePaths Condition="'@(ReferencePathWithRefAssemblies)' == '' AND '@(ReferencePath)' != ''">@(ReferencePath->WithMetadataValue('Extension', '.dll')->'%(FullPath)', ';')</_ProtoUtil_ReferencePaths>
		</PropertyGroup>
		<Message Text="PeakSWC.MvvmSourceGenerator: Reference paths being passed: $(_ProtoUtil_ReferencePaths)" Importance="normal" Condition="'$(_ProtoUtil_ReferencePaths)' != ''"/>

		<PropertyGroup>
			<_AttributeDefinitionSourceFileFullPath>$(MSBuildProjectDirectory)\$(_DefaultAttributeDefinitionSourceFileRelativePath)</_AttributeDefinitionSourceFileFullPath>
		</PropertyGroup>
		<Message Text="PeakSWC.MvvmSourceGenerator: GenerateGrpcRemoteAttribute.cs expected at: $(_AttributeDefinitionSourceFileFullPath)" Importance="normal" />
		<Error Condition="!Exists('$(_AttributeDefinitionSourceFileFullPath)')"
			   Text="PeakSWC.MvvmSourceGenerator: Critical Error: GenerateGrpcRemoteAttribute.cs not found at '$(_AttributeDefinitionSourceFileFullPath)'. This file is required by ProtoGeneratorUtil.exe, should be included by this NuGet package, and present in the project at the expected path." />

		<Exec Command="&quot;$(_ProtoGeneratorUtilExePath)&quot; ^
                   --viewModelFiles &quot;%(_MvvmViewModelProtoSourceProcessed.UserViewModelFile)&quot; ^
                   --attributeDefinitionSourceFile &quot;$(_AttributeDefinitionSourceFileFullPath)&quot; ^
                   --output &quot;%(_MvvmViewModelProtoSourceProcessed.FinalOutputPath)&quot; ^
                   --protoNamespace &quot;%(_MvvmViewModelProtoSourceProcessed.FinalProtoNamespace)&quot; ^
                   --serviceName &quot;%(_MvvmViewModelProtoSourceProcessed.FinalServiceName)&quot; ^
                   %(_MvvmViewModelProtoSourceProcessed.AdditionalArgs) ^
                   --referencePaths &quot;$(_ProtoUtil_ReferencePaths)&quot;"
			  WorkingDirectory="$(MSBuildProjectDirectory)"
			  ContinueOnError="false" />

		<ItemGroup>
			<Protobuf Include="@(_MvvmViewModelProtoSourceProcessed->'%(FinalOutputPath)')">
				<GrpcServices>%(_MvvmViewModelProtoSourceProcessed.FinalGrpcServices)</GrpcServices>
				<ProtoRoot>%(_MvvmViewModelProtoSourceProcessed.FinalProtoRoot)</ProtoRoot>
				<Access>%(_MvvmViewModelProtoSourceProcessed.FinalAccess)</Access>
			</Protobuf>
		</ItemGroup>
		<Message Text="PeakSWC.MvvmSourceGenerator: Added '@(_MvvmViewModelProtoSourceProcessed->'%(FinalOutputPath)')' to Protobuf items." Importance="normal" Condition="'@(_MvvmViewModelProtoSourceProcessed)' != ''"/>

		<Message Text="PeakSWC.MvvmSourceGenerator: .proto file generation complete." Importance="high" />
	</Target>

	<Target Name="PeakSWC_PrepareProtoGenerationItems" BeforeTargets="PeakSWC_GenerateProtoFiles">

		<ItemGroup>
			<_MvvmViewModelProtoSource_WithCalculatedNames Include="@(MvvmViewModelProtoSource)">
				<UserViewModelFile>%(MvvmViewModelProtoSource.FullPath)</UserViewModelFile>

				<UserProtoNamespace_In>%(MvvmViewModelProtoSource.ProtoNamespace)</UserProtoNamespace_In>
				<UserServiceName_In>%(MvvmViewModelProtoSource.ServiceName)</UserServiceName_In>
				<UserOutputPath_In>%(MvvmViewModelProtoSource.OutputPath)</UserOutputPath_In>
				<UserAttributeFullName_In>%(MvvmViewModelProtoSource.AttributeFullName)</UserAttributeFullName_In>
				<UserObservablePropertyAttribute_In>%(MvvmViewModelProtoSource.ObservablePropertyAttribute)</UserObservablePropertyAttribute_In>
				<UserRelayCommandAttribute_In>%(MvvmViewModelProtoSource.RelayCommandAttribute)</UserRelayCommandAttribute_In>
				<UserGrpcServices_In>%(MvvmViewModelProtoSource.GrpcServices)</UserGrpcServices_In>
				<UserProtoRoot_In>%(MvvmViewModelProtoSource.ProtoRoot)</UserProtoRoot_In>
				<UserAccess_In>%(MvvmViewModelProtoSource.Access)</UserAccess_In>

				<IntermediateProtoNamespace Condition="'$(ProtoNamespace)' == ''">$(Filename)Namespace.Protos</IntermediateProtoNamespace>
				<IntermediateProtoNamespace Condition="'$(ProtoNamespace)' != ''">$(ProtoNamespace)</IntermediateProtoNamespace>

				<IntermediateServiceName Condition="'$(ServiceName)' == ''">$(Filename)Service</IntermediateServiceName>
				<IntermediateServiceName Condition="'$(ServiceName)' != ''">$(ServiceName)</IntermediateServiceName>
			</_MvvmViewModelProtoSource_WithCalculatedNames>
		</ItemGroup>

		<!-- Debug output to check metadata values -->
		<Message Text="PeakSWC.MvvmSourceGenerator: Processing ViewModel: %(_MvvmViewModelProtoSource_WithCalculatedNames.Identity)" Importance="high" />
		<Message Text="PeakSWC.MvvmSourceGenerator: UserOutputPath_In: %(_MvvmViewModelProtoSource_WithCalculatedNames.UserOutputPath_In)" Importance="high" />
		<Message Text="PeakSWC.MvvmSourceGenerator: IntermediateServiceName: %(_MvvmViewModelProtoSource_WithCalculatedNames.IntermediateServiceName)" Importance="high" />

		<ItemGroup>
			<_MvvmViewModelProtoSourceProcessed Include="@(_MvvmViewModelProtoSource_WithCalculatedNames)">
				<UserViewModelFile>%(_MvvmViewModelProtoSource_WithCalculatedNames.UserViewModelFile)</UserViewModelFile>
				<FinalProtoNamespace>%(_MvvmViewModelProtoSource_WithCalculatedNames.IntermediateProtoNamespace)</FinalProtoNamespace>
				<FinalServiceName>%(_MvvmViewModelProtoSource_WithCalculatedNames.IntermediateServiceName)</FinalServiceName>

				<UserOutputPath_In>%(_MvvmViewModelProtoSource_WithCalculatedNames.UserOutputPath_In)</UserOutputPath_In>
				<UserAttributeFullName_In>%(_MvvmViewModelProtoSource_WithCalculatedNames.UserAttributeFullName_In)</UserAttributeFullName_In>
				<UserObservablePropertyAttribute_In>%(_MvvmViewModelProtoSource_WithCalculatedNames.UserObservablePropertyAttribute_In)</UserObservablePropertyAttribute_In>
				<UserRelayCommandAttribute_In>%(_MvvmViewModelProtoSource_WithCalculatedNames.UserRelayCommandAttribute_In)</UserRelayCommandAttribute_In>
				<UserGrpcServices_In>%(_MvvmViewModelProtoSource_WithCalculatedNames.UserGrpcServices_In)</UserGrpcServices_In>
				<UserProtoRoot_In>%(_MvvmViewModelProtoSource_WithCalculatedNames.UserProtoRoot_In)</UserProtoRoot_In>
				<UserAccess_In>%(_MvvmViewModelProtoSource_WithCalculatedNames.UserAccess_In)</UserAccess_In>

				<TempOutputPath>Protos\%(_MvvmViewModelProtoSource_WithCalculatedNames.IntermediateServiceName).proto</TempOutputPath>
				<TempOutputPath Condition="'%(_MvvmViewModelProtoSource_WithCalculatedNames.UserOutputPath_In)' != ''">%(_MvvmViewModelProtoSource_WithCalculatedNames.UserOutputPath_In)</TempOutputPath>

				<FinalOutputPath>$([MSBuild]::EnsureTrailingSlash('$(MSBuildProjectDirectory)'))</FinalOutputPath>
				<FinalOutputPath>$([System.IO.Path]::GetFullPath('%(FinalOutputPath)%(TempOutputPath)'))</FinalOutputPath>

				<FinalGrpcServices Condition="'%(_MvvmViewModelProtoSource_WithCalculatedNames.UserGrpcServices_In)' == ''">Both</FinalGrpcServices>
				<FinalGrpcServices Condition="'%(_MvvmViewModelProtoSource_WithCalculatedNames.UserGrpcServices_In)' != ''">%(_MvvmViewModelProtoSource_WithCalculatedNames.UserGrpcServices_In)</FinalGrpcServices>

				<FinalProtoRoot>$([System.IO.Path]::GetDirectoryName('%(FinalOutputPath)'))</FinalProtoRoot>
				<FinalProtoRoot Condition="'%(_MvvmViewModelProtoSource_WithCalculatedNames.UserProtoRoot_In)' != ''">%(_MvvmViewModelProtoSource_WithCalculatedNames.UserProtoRoot_In)</FinalProtoRoot>

				<FinalAccess Condition="'%(_MvvmViewModelProtoSource_WithCalculatedNames.UserAccess_In)' == ''">Public</FinalAccess>
				<FinalAccess Condition="'%(_MvvmViewModelProtoSource_WithCalculatedNames.UserAccess_In)' != ''">%(_MvvmViewModelProtoSource_WithCalculatedNames.UserAccess_In)</FinalAccess>

				<AdditionalArgs></AdditionalArgs>
				<AdditionalArgs Condition="'%(_MvvmViewModelProtoSource_WithCalculatedNames.UserAttributeFullName_In)' != ''">%(AdditionalArgs) --attributeFullName &quot;%(_MvvmViewModelProtoSource_WithCalculatedNames.UserAttributeFullName_In)&quot;</AdditionalArgs>
				<AdditionalArgs Condition="'%(_MvvmViewModelProtoSource_WithCalculatedNames.UserObservablePropertyAttribute_In)' != ''">%(AdditionalArgs) --observablePropertyAttribute &quot;%(_MvvmViewModelProtoSource_WithCalculatedNames.UserObservablePropertyAttribute_In)&quot;</AdditionalArgs>
				<AdditionalArgs Condition="'%(_MvvmViewModelProtoSource_WithCalculatedNames.UserRelayCommandAttribute_In)' != ''">%(AdditionalArgs) --relayCommandAttribute &quot;%(_MvvmViewModelProtoSource_WithCalculatedNames.UserRelayCommandAttribute_In)&quot;</AdditionalArgs>
			</_MvvmViewModelProtoSourceProcessed>
		</ItemGroup>

		<!-- Debug output for processed items -->
		<Message Text="PeakSWC.MvvmSourceGenerator: Processed output: %(_MvvmViewModelProtoSourceProcessed.Identity)" Importance="high" />
		<Message Text="PeakSWC.MvvmSourceGenerator: TempOutputPath: %(_MvvmViewModelProtoSourceProcessed.TempOutputPath)" Importance="high" />
		<Message Text="PeakSWC.MvvmSourceGenerator: FinalOutputPath: %(_MvvmViewModelProtoSourceProcessed.FinalOutputPath)" Importance="high" />

		<PropertyGroup Condition="'@(_MvvmViewModelProtoSourceProcessed)' == ''">
			<PeakSWC_NoViewModelsToProcess>true</PeakSWC_NoViewModelsToProcess>
		</PropertyGroup>
		<Message Text="PeakSWC.MvvmSourceGenerator: No MvvmViewModelProtoSource items found to process." Importance="normal" Condition="'$(PeakSWC_NoViewModelsToProcess)' == 'true'" />

		<ItemGroup>
			<_MvvmViewModelProtoSource_WithCalculatedNames Remove="@(_MvvmViewModelProtoSource_WithCalculatedNames)" />
		</ItemGroup>
	</Target>

	<Import Project="PeakSWC.MvvmSourceGenerator.props" Condition="Exists('PeakSWC.MvvmSourceGenerator.props')"/>
</Project>