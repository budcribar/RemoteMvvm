<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<!-- ... existing PropertyGroup for _ProtoGeneratorUtilExePath ... -->
	<PropertyGroup>
		<_Net8ToolPathForExists>$(MSBuildThisFileDirectory)..\tools\net8.0\ProtoGeneratorUtil.exe</_Net8ToolPathForExists>
		<_Net6ToolPathForExists>$(MSBuildThisFileDirectory)..\tools\net6.0\ProtoGeneratorUtil.exe</_Net6ToolPathForExists>

		<_ProtoGeneratorUtilExePath Condition="Exists('$(_Net8ToolPathForExists)')">$(MSBuildThisFileDirectory)..\tools\net8.0\ProtoGeneratorUtil.exe</_ProtoGeneratorUtilExePath>
		<_ProtoGeneratorUtilExePath Condition="Exists('$(_Net6ToolPathForExists)') AND '$(_ProtoGeneratorUtilExePath)' == ''">$(MSBuildThisFileDirectory)..\tools\net6.0\ProtoGeneratorUtil.exe</_ProtoGeneratorUtilExePath>
	</PropertyGroup>

	<Target Name="PeakSWC_GenerateProtoFiles"
            BeforeTargets="CoreCompile;BeforeResGen;ProtoCompile"
            DependsOnTargets="ResolveAssemblyReferences;PeakSWC_PrepareProtoGenerationItems"
            Condition="'@(_MvvmViewModelProtoSourceProcessed)' != '' AND '$(_ProtoGeneratorUtilExePath)' != '' AND Exists('$(_ProtoGeneratorUtilExePath)')">

		<Message Importance="high" Text="PeakSWC.MvvmSourceGenerator: Starting .proto file generation..." />
		<Message Importance="normal" Text="PeakSWC.MvvmSourceGenerator: ProtoGeneratorUtil.exe path: $(_ProtoGeneratorUtilExePath)" />

		<PropertyGroup>
			<_ProtoUtil_ReferencePaths Condition="'@(ReferencePathWithRefAssemblies)' != ''">@(ReferencePathWithRefAssemblies->WithMetadataValue('Extension', '.dll')->'%(FullPath)', ';')</_ProtoUtil_ReferencePaths>
			<_ProtoUtil_ReferencePaths Condition="'@(ReferencePathWithRefAssemblies)' == '' AND '@(ReferencePath)' != ''">@(ReferencePath->WithMetadataValue('Extension', '.dll')->'%(FullPath)', ';')</_ProtoUtil_ReferencePaths>
		</PropertyGroup>
		<Message Importance="normal" Text="PeakSWC.MvvmSourceGenerator: Reference paths being passed: $(_ProtoUtil_ReferencePaths)" Condition="'$(_ProtoUtil_ReferencePaths)' != ''"/>

		<Exec Command=""$(_ProtoGeneratorUtilExePath=""
                      --viewModelFiles "%(_MvvmViewModelProtoSourceProcessed.UserViewModelFile=""
                      --attributeDefinitionSourceFile "%(_MvvmViewModelProtoSourceProcessed.FinalAttributeDefinitionSourceFile=""
                      --output "%(_MvvmViewModelProtoSourceProcessed.FinalOutputPath=""
                      --protoNamespace "%(_MvvmViewModelProtoSourceProcessed.FinalProtoNamespace=""
                      --serviceName "%(_MvvmViewModelProtoSourceProcessed.FinalServiceName=""
                      %(_MvvmViewModelProtoSourceProcessed.AdditionalArgs) ^
                      --referencePaths "$(_ProtoUtil_ReferencePaths=""
              WorkingDirectory="$(MSBuildProjectDirectory)"
              ContinueOnError="false" />

		<ItemGroup>
			<Protobuf Include="@(_MvvmViewModelProtoSourceProcessed->'%(FinalOutputPath)')">
				<GrpcServices>%(_MvvmViewModelProtoSourceProcessed.FinalGrpcServices)</GrpcServices>
				<ProtoRoot>%(_MvvmViewModelProtoSourceProcessed.FinalProtoRoot)</ProtoRoot>
				<Access>%(_MvvmViewModelProtoSourceProcessed.FinalAccess)</Access>
			</Protobuf>
		</ItemGroup>
		<Message Importance="normal" Text="PeakSWC.MvvmSourceGenerator: Added '@(_MvvmViewModelProtoSourceProcessed->'%(FinalOutputPath)')' to Protobuf items." Condition="'@(_MvvmViewModelProtoSourceProcessed)' != ''"/>

		<Message Importance="high" Text="PeakSWC.MvvmSourceGenerator: .proto file generation complete." />
	</Target>

	<Target Name="PeakSWC_PrepareProtoGenerationItems" BeforeTargets="PeakSWC_GenerateProtoFiles">

		<PropertyGroup>
			<!-- Define the default path here -->
			<DefaultAttributeDefinitionSourceFile>PeakSWC/Mvvm/Remote/GenerateGrpcRemoteAttribute.cs</DefaultAttributeDefinitionSourceFile>
		</PropertyGroup>

		<ItemGroup>
			<_MvvmViewModelProtoSource_WithInputs Include="@(MvvmViewModelProtoSource)">
				<UserViewModelFile>%(MvvmViewModelProtoSource.FullPath)</UserViewModelFile>
				<CalculatedIntermediateProtoNamespace Condition="'%(MvvmViewModelProtoSource.ProtoNamespace)' == ''">%(MvvmViewModelProtoSource.Filename)Namespace.Protos</CalculatedIntermediateProtoNamespace>
				<CalculatedIntermediateProtoNamespace Condition="'%(MvvmViewModelProtoSource.ProtoNamespace)' != ''">%(MvvmViewModelProtoSource.ProtoNamespace)</CalculatedIntermediateProtoNamespace>
				<CalculatedIntermediateServiceName Condition="'%(MvvmViewModelProtoSource.ServiceName)' == ''">%(MvvmViewModelProtoSource.Filename)Service</CalculatedIntermediateServiceName>
				<CalculatedIntermediateServiceName Condition="'%(MvvmViewModelProtoSource.ServiceName)' != ''">%(MvvmViewModelProtoSource.ServiceName)</CalculatedIntermediateServiceName>
				<UserOutputPath_Input>%(MvvmViewModelProtoSource.OutputPath)</UserOutputPath_Input>
				<UserAttributeFullName_Input>%(MvvmViewModelProtoSource.AttributeFullName)</UserAttributeFullName_Input>
				<UserObservablePropertyAttribute_Input>%(MvvmViewModelProtoSource.ObservablePropertyAttribute)</UserObservablePropertyAttribute_Input>
				<UserRelayCommandAttribute_Input>%(MvvmViewModelProtoSource.RelayCommandAttribute)</UserRelayCommandAttribute_Input>
				<UserGrpcServices_Input>%(MvvmViewModelProtoSource.GrpcServices)</UserGrpcServices_Input>
				<UserProtoRoot_Input>%(MvvmViewModelProtoSource.ProtoRoot)</UserProtoRoot_Input>
				<UserAccess_Input>%(MvvmViewModelProtoSource.Access)</UserAccess_Input>
				<UserAttributeDefinitionSourceFile_Input>%(MvvmViewModelProtoSource.AttributeDefinitionSourceFile)</UserAttributeDefinitionSourceFile_Input>
			</_MvvmViewModelProtoSource_WithInputs>
		</ItemGroup>

		<!-- ... existing _S1_Base, _S2_RelPath, _S3_AbsPath ... -->
		<ItemGroup>
			<_MvvmViewModelProtoSource_S1_Base Include="@(_MvvmViewModelProtoSource_WithInputs)">
				<FinalProtoNamespace>%(CalculatedIntermediateProtoNamespace)</FinalProtoNamespace>
				<FinalServiceName>%(CalculatedIntermediateServiceName)</FinalServiceName>
				<TempOutputPath Condition="'%(UserOutputPath_Input)' == ''">Protos\%(CalculatedIntermediateServiceName).proto</TempOutputPath>
				<TempOutputPath Condition="'%(UserOutputPath_Input)' != ''">%(UserOutputPath_Input)</TempOutputPath>
			</_MvvmViewModelProtoSource_S1_Base>
		</ItemGroup>

		<ItemGroup>
			<_MvvmViewModelProtoSource_S2_RelPath Include="@(_MvvmViewModelProtoSource_S1_Base)">
				<IntermediateRelativeFinalOutputPath>$([MSBuild]::EnsureTrailingSlash('$(MSBuildProjectDirectory)'))%(TempOutputPath)</IntermediateRelativeFinalOutputPath>
			</_MvvmViewModelProtoSource_S2_RelPath>
		</ItemGroup>

		<ItemGroup>
			<_MvvmViewModelProtoSource_S3_AbsPath Include="@(_MvvmViewModelProtoSource_S2_RelPath)">
				<FinalOutputPath Condition="'%(IntermediateRelativeFinalOutputPath)' != ''">$([System.IO.Path]::GetFullPath('%(IntermediateRelativeFinalOutputPath)'))</FinalOutputPath>
				<FinalOutputPath Condition="'%(IntermediateRelativeFinalOutputPath)' == ''">_MALFORMED_FINALOUTPUTPATH_</FinalOutputPath>
			</_MvvmViewModelProtoSource_S3_AbsPath>
		</ItemGroup>

		<!-- Optional arguments construction (S4, S5, S6, S7) remains the same -->
		<ItemGroup>
			<_MvvmViewModelProtoSource_S4_Arg1 Include="@(_MvvmViewModelProtoSource_S3_AbsPath)">
				<_ArgPartForFullName></_ArgPartForFullName>
				<_ArgPartForFullName Condition="'%(UserAttributeFullName_Input)' != ''"> --attributeFullName "%(UserAttributeFullName_Input)"</_ArgPartForFullName>
			</_MvvmViewModelProtoSource_S4_Arg1>
		</ItemGroup>

		<ItemGroup>
			<_MvvmViewModelProtoSource_S5_Arg2 Include="@(_MvvmViewModelProtoSource_S4_Arg1)">
				<_ArgPartForObservableProperty></_ArgPartForObservableProperty>
				<_ArgPartForObservableProperty Condition="'%(UserObservablePropertyAttribute_Input)' != ''"> --observablePropertyAttribute "%(UserObservablePropertyAttribute_Input)"</_ArgPartForObservableProperty>
			</_MvvmViewModelProtoSource_S5_Arg2>
		</ItemGroup>

		<ItemGroup>
			<_MvvmViewModelProtoSource_S6_Arg3 Include="@(_MvvmViewModelProtoSource_S5_Arg2)">
				<_ArgPartForRelayCommand></_ArgPartForRelayCommand>
				<_ArgPartForRelayCommand Condition="'%(UserRelayCommandAttribute_Input)' != ''"> --relayCommandAttribute "%(UserRelayCommandAttribute_Input)"</_ArgPartForRelayCommand>
			</_MvvmViewModelProtoSource_S6_Arg3>
		</ItemGroup>

		<ItemGroup>
			<_MvvmViewModelProtoSource_S7_CombinedArgs Include="@(_MvvmViewModelProtoSource_S6_Arg3)">
				<AdditionalArgs>%(_ArgPartForFullName)%(_ArgPartForObservableProperty)%(_ArgPartForRelayCommand)</AdditionalArgs>
			</_MvvmViewModelProtoSource_S7_CombinedArgs>
		</ItemGroup>

		<ItemGroup>
			<_MvvmViewModelProtoSourceProcessed Include="@(_MvvmViewModelProtoSource_S7_CombinedArgs)">
				<FinalProtoRoot Condition="'%(UserProtoRoot_Input)' == '' AND '%(FinalOutputPath)' != '' AND '%(FinalOutputPath)' != '_MALFORMED_FINALOUTPUTPATH_'">$([System.IO.Path]::GetDirectoryName('%(FinalOutputPath)'))</FinalProtoRoot>
				<FinalProtoRoot Condition="'%(UserProtoRoot_Input)' == '' AND ('%(FinalOutputPath)' == '' OR '%(FinalOutputPath)' == '_MALFORMED_FINALOUTPUTPATH_')">_ERROR_FINALPROTOOUTPUTPATH_INVALID_FOR_%(Identity)</FinalProtoRoot>
				<FinalProtoRoot Condition="'%(UserProtoRoot_Input)' != ''">%(UserProtoRoot_Input)</FinalProtoRoot>

				<FinalGrpcServices Condition="'%(UserGrpcServices_Input)' == ''">Both</FinalGrpcServices>
				<FinalGrpcServices Condition="'%(UserGrpcServices_Input)' != ''">%(UserGrpcServices_Input)</FinalGrpcServices>

				<FinalAccess Condition="'%(UserAccess_Input)' == ''">Public</FinalAccess>
				<FinalAccess Condition="'%(UserAccess_Input)' != ''">%(UserAccess_Input)</FinalAccess>

				<!-- MODIFIED: Set default if user input is empty -->
				<FinalAttributeDefinitionSourceFile Condition="'%(UserAttributeDefinitionSourceFile_Input)' != ''">%(UserAttributeDefinitionSourceFile_Input)</FinalAttributeDefinitionSourceFile>
				<FinalAttributeDefinitionSourceFile Condition="'%(UserAttributeDefinitionSourceFile_Input)' == ''">$(DefaultAttributeDefinitionSourceFile)</FinalAttributeDefinitionSourceFile>
			</_MvvmViewModelProtoSourceProcessed>
		</ItemGroup>

		<!-- Optional: You might want to verify the default file exists if it's used.
             Or, ensure your ProtoGeneratorUtil.exe can handle a non-existent file if it's a default that the user might not have yet.
             For now, the previous error for a *missing* user-provided path is removed, as we now always provide a path.
        -->
		<!-- REMOVED Error Task for missing required metadata, as we now provide a default -->
		<!--
        <Error Condition="'@(_MvvmViewModelProtoSourceProcessed)' != '' AND '%(_MvvmViewModelProtoSourceProcessed.FinalAttributeDefinitionSourceFile)' == ''"
               Text="MvvmViewModelProtoSource item '%(_MvvmViewModelProtoSourceProcessed.Identity)' is missing the required 'AttributeDefinitionSourceFile' metadata. Please specify the path to the C# file containing the GenerateGrpcRemoteAttribute definition." />
        -->

		<PropertyGroup Condition="'@(_MvvmViewModelProtoSourceProcessed)' == ''">
			<PeakSWC_NoViewModelsToProcess>true</PeakSWC_NoViewModelsToProcess>
		</PropertyGroup>
		<Message Importance="normal" Text="PeakSWC.MvvmSourceGenerator: No MvvmViewModelProtoSource items found to process." Condition="'$(PeakSWC_NoViewModelsToProcess)' == 'true'" />

		<ItemGroup>
			<!-- ... existing cleanup of intermediate ItemGroups ... -->
			<_MvvmViewModelProtoSource_WithInputs Remove="@(_MvvmViewModelProtoSource_WithInputs)" />
			<_MvvmViewModelProtoSource_S1_Base Remove="@(_MvvmViewModelProtoSource_S1_Base)" />
			<_MvvmViewModelProtoSource_S2_RelPath Remove="@(_MvvmViewModelProtoSource_S2_RelPath)" />
			<_MvvmViewModelProtoSource_S3_AbsPath Remove="@(_MvvmViewModelProtoSource_S3_AbsPath)" />
			<_MvvmViewModelProtoSource_S4_Arg1 Remove="@(_MvvmViewModelProtoSource_S4_Arg1)" />
			<_MvvmViewModelProtoSource_S5_Arg2 Remove="@(_MvvmViewModelProtoSource_S5_Arg2)" />
			<_MvvmViewModelProtoSource_S6_Arg3 Remove="@(_MvvmViewModelProtoSource_S6_Arg3)" />
			<_MvvmViewModelProtoSource_S7_CombinedArgs Remove="@(_MvvmViewModelProtoSource_S7_CombinedArgs)" />
		</ItemGroup>
	</Target>
</Project>