<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<!-- 1) Capture every PackageReference into our own item -->
	<ItemGroup>
		<CompilerVisibleProperty Include="GrpcServices" />
		<_PeakSWCSourceGenPkg
		  Include="@(PackageReference)">
			<PkgIdentity>%(PackageReference.Identity)</PkgIdentity>
			<PkgGrpcServices>%(PackageReference.GrpcServices)</PkgGrpcServices>
		</_PeakSWCSourceGenPkg>
	</ItemGroup>

	<!-- 2) Make MvvmViewModelProtoSource available -->
	<ItemGroup>
		<AvailableItemName Include="MvvmViewModelProtoSource" />
	</ItemGroup>

	<!-- 3) The target that reads/transforms GrpcServices -->
	<Target Name="PeakSWC_SetGrpcServices" BeforeTargets="CoreCompile">

		<!-- 3a) Filter down to *our* package -->
		<ItemGroup>
			<_FilteredPkg
			  Include="@(_PeakSWCSourceGenPkg)"
			  Condition="'%(PkgIdentity)' == 'PeakSWC.MvvmSourceGenerator'" />
		</ItemGroup>

		<!-- 3b) If the user hasn’t set GrpcServices, grab & clean ours -->
		<PropertyGroup>
			<!-- raw (may contain whitespace/newlines) -->
			<_RawGrpcServices
			  Condition="
          '$(GrpcServices)' == ''
          and '@(_FilteredPkg)' != ''
        ">
				%(_FilteredPkg.PkgGrpcServices)
			</_RawGrpcServices>

			<!-- strip ALL whitespace -->
			<GrpcServices
			  Condition="
          '$(GrpcServices)' == ''
          and '$(_RawGrpcServices)' != ''
        ">
				$([System.Text.RegularExpressions.Regex]::Replace('$(_RawGrpcServices)', '\s+', ''))
			</GrpcServices>
		</PropertyGroup>

		<!-- 3c) (Optional) Debug message *inside* the target -->
		<Message
		  Importance="high"
		  Condition="'$(GrpcServices)' != ''"
		  Text="GrpcServices is now: '$(GrpcServices)'" />
	</Target>

</Project>

